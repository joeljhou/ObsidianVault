* å‚è€ƒå®˜ç½‘æ–‡æ¡£ï¼š[æ¥æ”¶æ¨é€é€šçŸ¥](https://developers.google.com/gmail/api/guides/push?hl=zh-cn)
* [YouTubeæ•™ç¨‹](https://www.youtube.com/watch?v=cgxQPUyZAXk)

## åˆ›å»ºä¸»é¢˜
```shell
projects/geekyspace/topics/gmail-webhook-topic
```

## åˆ›å»ºè®¢é˜…
```shell
projects/geekyspace/subscriptions/gmail-webhook-topic-sub
```
![åˆ›å»ºè®¢é˜…](http://img.geekyspace.cn/pictures/2025/20250302201541234.png)

## pythonå®ç°webhook
é€šè¿‡FastAPIå®ç°ä¸€ä¸ªç®€å•çš„`webhook.py`ä»£ç ï¼Œç«¯å£å·4000
```python
import uvicorn  
import base64  
import json  
import logging  
  
from fastapi import FastAPI, Request, HTTPException  
  
app = FastAPI(redirect_slashes=False)  
  
@app.get("/")  
async def root():  
    return {"message": "Hello World"}  
  
@app.post("/webhook/gmail")  
async def webhook_gmail(request: Request):  
    """ å¤„ç† Gmail Pub/Sub Webhook å›è°ƒ """    try:  
        payload = await request.json()  
        logging.info(f"Received webhook: {json.dumps(payload, indent=2)}")  
  
        # ç¡®ä¿æ¶ˆæ¯å­˜åœ¨  
        if "message" not in payload:  
            raise HTTPException(status_code=400, detail="Invalid Pub/Sub message")  
  
        # è§£æ Base64 ç¼–ç çš„æ•°æ®  
        pubsub_message = payload["message"]  
        message_data = base64.urlsafe_b64decode(pubsub_message["data"]).decode("utf-8")  
        # ğŸš€ è®°å½•æ—¥å¿—ï¼Œç¡®ä¿å†…å®¹æ­£ç¡®  
        logging.info(f"Decoded message data: {message_data}")  
        return  
    except Exception as e:  
        logging.error(f"Error processing webhook: {e}")  
        raise HTTPException(status_code=500, detail="Internal server error")  
  
if __name__ == "__main__":  
    uvicorn.run("webhook:app", host="0.0.0.0", port=4000, reload=True)
```
## ngrokå†…ç½‘ç©¿é€è®¾ç½®å›è°ƒ
å®˜ç½‘ä¸‹è½½ï¼š[https://ngrok.com/](https://ngrok.com/)

**ç¬¬ä¸€æ­¥ï¼šTokené‰´æƒ**
```shell
ngrok config add-authtoken 2tksRaJq6oVTUBNlGkXMCEUsrbf_6Tfo93wDTufuuaoUBkRYW
```
**ç¬¬äºŒæ­¥ï¼šæŒ‡å®šç«¯å£ç©¿é€ä½¿ç”¨**
```shell
ngrok http http://localhost:4000
```
![å†…ç½‘ç©¿é€](http://img.geekyspace.cn/pictures/2025/20250302175643239.png)
**åˆ©ç”¨ngrokç›‘å¬webhookè¯·æ±‚**
 [http://127.0.0.1:4040/inspect/http](http://127.0.0.1:4040/inspect/http)
![image.png](http://img.geekyspace.cn/pictures/2025/20250302202303383.png)

## æ‰‹åŠ¨å‘å¸ƒæ¶ˆæ¯æµ‹è¯•
![å‘å¸ƒæ¶ˆæ¯](http://img.geekyspace.cn/pictures/2025/20250302202122768.png)

## è‡ªåŠ¨Gmail PubSubæµ‹è¯•
### ä¸ºGmailæˆäºˆå‘ä¸»é¢˜å‘å¸ƒçš„æƒé™
```shell
gmail-api-push@system.gserviceaccount.com
```

ä¸ºæ­¤ï¼Œæ‚¨éœ€è¦å‘Â `gmail-api-push@system.gserviceaccount.com`Â æˆäºˆÂ `publish`Â æƒé™ã€‚æ‚¨å¯ä»¥æŒ‰ç…§[èµ„æºçº§è®¿é—®æƒé™æ§åˆ¶è¯´æ˜](https://cloud.google.com/pubsub/access_control?hl=zh-cn#set_topic_level_access)ï¼Œä½¿ç”¨Â [Cloud Pub/Sub å¼€å‘è€…æ§åˆ¶å°æƒé™ç•Œé¢](https://console.cloud.google.com/project/_/cloudpubsub/topicList?hl=zh-cn)æ‰§è¡Œæ­¤æ“ä½œã€‚

![æˆäºˆå‘å¸ƒè®¿é—®æƒé™](http://img.geekyspace.cn/pictures/2025/20250302191216581.png)

### `watch`ç›‘è§†è¯·æ±‚ï¼ˆç»­è®¢ï¼‰

> å°† Gmail è´¦å·é…ç½®ä¸ºå‘ `Cloud Pub/Sub` ä¸»é¢˜å‘é€é€šçŸ¥

[watch api](https://developers.google.com/gmail/api/reference/rest/v1/users/watch?hl=zh-cn)

**ä½¿ç”¨`credentials.json`å†…å®¹ç”ŸæˆOAuth2 çš„ Token**

![ç”ŸæˆToken](http://img.geekyspace.cn/pictures/2025/20250302212500374.png)

**è¯·æ±‚æ¥å£**
åªéœ€ä½¿ç”¨Â Gmail APIÂ å®¢æˆ·ç«¯å¯¹ Gmail ç”¨æˆ·é‚®ç®±è°ƒç”¨Â [`watch`](https://developers.google.com/gmail/api/v1/reference/users/watch?hl=zh-cn)ï¼Œå°±åƒè°ƒç”¨ä»»ä½•å…¶ä»– Gmail API ä¸€æ ·ã€‚ä¸ºæ­¤ï¼Œè¯·åœ¨Â `watch`Â è¯·æ±‚ä¸­æä¾›ä¸Šè¿°åˆ›å»ºçš„ä¸»é¢˜åç§°ä»¥åŠä»»ä½•å…¶ä»–é€‰é¡¹ï¼Œä¾‹å¦‚è¦ç”¨äºè¿‡æ»¤çš„Â [`labels`](https://developers.google.com/gmail/api/guides/labels?hl=zh-cn)ã€‚ä¾‹å¦‚ï¼Œè‹¥è¦æ¯å½“æ”¶ä»¶ç®±å‘ç”Ÿæ›´æ”¹æ—¶æ”¶åˆ°é€šçŸ¥ï¼Œè¯·æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š
```
POST "https://www.googleapis.com/gmail/v1/users/me/watch"
Content-type: application/json

{
Â  "topicName": "projects/geekyspace/topics/gmail-webhook-topic",
Â  "labelIds": ["INBOX"],
Â  "labelFilterBehavior": "INCLUDE"
}
```
![image.png](http://img.geekyspace.cn/pictures/2025/20250302212749116.png)
### å‘é€Gmailé‚®ä»¶æµ‹è¯•

**æˆåŠŸæ”¶åˆ°å›è°ƒ**
![image.png](http://img.geekyspace.cn/pictures/2025/20250302214749085.png)

**è§£ç è·å–`historyId`**
```json
{"emailAddress":"joeljhou336@gmail.com","historyId":392257}
```
![base64è§£ç ](http://img.geekyspace.cn/pictures/2025/20250302214628411.png)

### æ ¹æ®`historyId`è·å–æ¶ˆæ¯å†…å®¹
* æ³¨æ„ï¼šä½¿ç”¨æœ€æ–°çš„`historyId`è·å–ä¸åˆ°ç»“æœï¼Œä½¿ç”¨å‰ä¸€ä¸ª`historyId`æŸ¥è¯¢å¹¶è®°å½•å½“å‰å€¼
[åˆ—å‡ºæŒ‡å®šé‚®ç®±çš„æ‰€æœ‰æ›´æ”¹çš„å†å²è®°å½•ã€‚å†å²è®°å½•ç»“æœæŒ‰æ—¶é—´é¡ºåºè¿”å›ï¼ˆé€’å¢Â `historyId`ï¼‰ã€‚](https://developers.google.com/gmail/api/reference/rest/v1/users.history/list?hl=zh-cn)

![image.png](http://img.geekyspace.cn/pictures/2025/20250302225641067.png)

æ ¹æ®è¿”å›ç»“æœä¸­çš„`messages_id`è·å–æœ€ç»ˆæ¶ˆæ¯

[API-è·å–æŒ‡å®šçš„æ¶ˆæ¯](https://developers.google.com/gmail/api/reference/rest/v1/users.messages/get?hl=zh-cn)
![image.png](http://img.geekyspace.cn/pictures/2025/20250302225845959.png)
